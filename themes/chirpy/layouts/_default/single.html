<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}">
{{ partial "head.html" . }}
<body>
  {{ partial "header.html" . }}
  <div id="main-wrapper" class="d-flex justify-content-center">
    <div class="container d-flex flex-column px-xxl-5">
      {{ partial "content_top.html" . }}
      <div class="row flex-grow-1">
        <main class="col-12 col-lg-11 col-xl-9 px-md-4">
          <article class="px-1">
            <header>
              <h1 data-toc-skip="">{{ .Title }}</h1>
              <!-- <p class="post-desc fw-light mb-4"></p> -->
              {{ if in .Site.Params.mainSections .Type }}
              <div class="post-meta text-muted">
                <!-- <span>å‘å¸ƒäº <time>{{ .Date.Format "Jan 2, 2006"}}</time></span> -->
                <span>å‘å¸ƒäº <time>{{ .Date.Format "2006å¹´1æœˆ2æ—¥"}}</time></span>
              
                <div class="d-flex justify-content-between">
                  <span>By <em><a href="https://github.com/lsx-xyg">å’¸é±¼</a></em></span>
                </div>
              </div>
              {{ end }}
            </header>
            <div class="content">
              {{ .Site.Params.postHeaderContent | safeHTML }}
              {{ .Content }}
              <div class="post-tail-wrapper text-muted">
                <div class="post-meta mb-3">
                  <!-- if æ˜¯è¯¦æƒ…é¡µ -->
                  {{ if in .Site.Params.mainSections .Type }}
                  {{ if .Params.categories }}
                  <i class="far fa-folder-open fa-fw me-1"></i>
                  <span class="post-category">
                    {{/* with è¯­å¥å¯ä»¥ç¡®ä¿åˆ†ç±»å­˜åœ¨ï¼Œå¹¶å°†ç¬¬ä¸€ä¸ªåˆ†ç±»èµ‹å€¼ç»™ . */}}
                    {{ with index .Params.categories 0 }}
                      <a href="{{ "/categories/" | relLangURL }}{{ . | urlize }}">{{ . }}</a>
                    {{ end }}
                  </span>
                  {{ end }}
                  <div class="post-tags">
                    <i class="fa fa-tags fa-fw me-1"></i>
                    {{ if .Params.tags }}
                    <span class="post-tags">
                      {{ range .Params.tags }}
                        <a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}" class="post-tag no-text-decoration">{{ . }}</a>
                      {{ end }}
                    </span>
                  {{ end }}
                  </div>
                  {{ end }}
                  <!-- if æ˜¯è¯¦æƒ…é¡µ -->

                  <!-- æ–‡ç« åè®® -->
                  <div class="post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2">
                    <div class="license-wrapper">This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div>
                  </div>

                </div>
              </div>

              {{ if in .Site.Params.mainSections .Type }}
              <!-- åœ¨æ–‡ç« å†…å®¹ä¹‹åæ˜¾ç¤ºç›¸å…³æ–‡ç«  -->
              {{ partial "related-posts.html" . }}
              {{ end }}

              <!-- è¯„è®º -->
              {{ if in .Site.Params.mainSections .Type }}
              {{ partial "comment.html" . }}
              {{ end }}

            </div>
          </article>
          {{ partial "footer.html" . }}
        </main>
        {{ partial "panel.html" . }}
      </div>
    </div>
  </div>

<!-- æœ€ç»ˆä¼˜åŒ–ç‰ˆ -->
{{ if .IsPage }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // --- è¯·æ ¹æ®ä½ çš„ä¸»é¢˜ä¿®æ”¹ä¸‹é¢è¿™ä¸¤ä¸ªé€‰æ‹©å™¨ ---
  const contentSelector = '.content'; // <--- ä¿®æ”¹è¿™é‡Œ
  const tocSelector = '#TableOfContents'; // <--- ä¿®æ”¹è¿™é‡Œ

  const headings = Array.from(document.querySelectorAll(`${contentSelector} h2, ${contentSelector} h3`));
  const tocLinks = document.querySelectorAll(`${tocSelector} a`);
  
  if (headings.length === 0 || tocLinks.length === 0) {
    return;
  }

  // åˆ›å»ºä¸€ä¸ª Map ç”¨äºé€šè¿‡æ ‡é¢˜ ID å¿«é€ŸæŸ¥æ‰¾ TOC é“¾æ¥
  const tocLinkMap = new Map();
  tocLinks.forEach(link => {
    const href = link.getAttribute('href');
    if (href) {
      tocLinkMap.set(href.substring(1), link);
    }
  });

  let currentActiveLink = null; // ç”¨äºè®°å½•å½“å‰é«˜äº®çš„é“¾æ¥

  const observer = new IntersectionObserver(entries => {
    // æ‰¾åˆ°æ‰€æœ‰å½“å‰åœ¨è§†å£å†…çš„æ ‡é¢˜
    const visibleHeadings = entries
      .filter(entry => entry.isIntersecting)
      .map(entry => entry.target);

    // å¦‚æœæ²¡æœ‰å¯è§çš„æ ‡é¢˜ï¼Œåˆ™ä¸åšä»»ä½•äº‹ï¼ˆä¿ç•™ä¸Šä¸€ä¸ªé«˜äº®çŠ¶æ€ï¼‰
    if (visibleHeadings.length === 0) {
      return;
    }

    // å°†å¯è§æ ‡é¢˜æŒ‰å…¶åœ¨é¡µé¢ä¸­çš„ä½ç½®æ’åºï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰
    visibleHeadings.sort((a, b) => a.offsetTop - b.offsetTop);

    // ç¬¬ä¸€ä¸ªå¯è§çš„æ ‡é¢˜å°±æ˜¯æˆ‘ä»¬æƒ³è¦é«˜äº®çš„
    const topVisibleHeading = visibleHeadings[0];
    const id = topVisibleHeading.getAttribute('id');
    const newActiveLink = tocLinkMap.get(id);

    // ğŸŒŸ æ ¸å¿ƒé€»è¾‘ï¼šåªæœ‰åœ¨éœ€è¦åˆ‡æ¢é«˜äº®é“¾æ¥æ—¶æ‰æ“ä½œ DOM
    if (newActiveLink && newActiveLink !== currentActiveLink) {
      // ç§»é™¤æ—§çš„é«˜äº®
      if (currentActiveLink) {
        currentActiveLink.classList.remove('active');
      }
      // æ·»åŠ æ–°çš„é«˜äº®
      newActiveLink.classList.add('active');
      // æ›´æ–°å½“å‰é«˜äº®é“¾æ¥çš„è®°å½•
      currentActiveLink = newActiveLink;
    }
  }, {
    // rootMargin å†³å®šäº†æ ‡é¢˜åœ¨å±å¹•çš„å“ªä¸ªåŒºåŸŸè¢«è§†ä¸ºâ€œæ¿€æ´»â€
    // '0px 0px -75% 0px' æ„å‘³ç€æ ‡é¢˜éœ€è¦æ»šåŠ¨åˆ°å±å¹•ä¸ŠåŠéƒ¨åˆ†çš„å‰ 25% åŒºåŸŸæ—¶æ‰ä¼šè¢«æ¿€æ´»
    // è¿™æœ‰åŠ©äºé˜²æ­¢é¡µé¢åº•éƒ¨çš„æ ‡é¢˜è¿‡æ—©åœ°æŠ¢å é«˜äº®
    rootMargin: '0px 0px -70% 0px',
    threshold: 0.1 // æ ‡é¢˜è‡³å°‘æœ‰ 10% å¯è§æ—¶æ‰è§¦å‘
  });

  headings.forEach(heading => observer.observe(heading));
});
</script>
{{ end }}


{{ partial "scripts.html" . }}
</body>
</html>